# Calculating Temporal And Spatial Walk-off Effects In Birefringent Crystal Systems | Thorlabs EDU-QOPA1(/M)
This repository contains code used for walk-off calculation as described in detail in the [manual for the Thorlabs EDU-QOPA1(/M)](https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=15827) polarization-entanglement addon to the educational quantum optics kit.

This readme assumes a working understanding of the calculation of these walk-off effects in general and focusses on the description of the python code implementation of the calculation.

## Requirements 
The code is contained in a single file **Crystal_walkoffs.py** that can be run as script using a python interpreter of version 3.9 or later. It makes use of the python packages *numpy, scipy* and *matplotlib*.

## Purpose and Output
The script main purpose is to calculate the temporal and spatial walk-off of an entangled photon-pair source, based on a crossed BBO pair for Type-I SPDC, and the compensation of these effects by additional birefringent compensation crystals.
The most important output options and features are:
 - Text summary for **temporal** walk-off [^OptExp2009] picked up by photons passing the crystals.
   - Optional: Detailed list of walk-off in each crystal.
   - Optional: Based on given pump laser bandwith estimates the phase spread of the entangled state due to temporal walk-off.
   - Optional: Advice on how the temporal compensation crystal may be adjusted to improve compensation.
 - Text summary for **spatial** walk-off [^OptExp2005] picked up by photons passing the crystals.
   - Optional: Detailed list of walk-off in each crystal.
   - Optional: Calculation of birefringent beam displacement and phase difference.
 - Plots of spatial walk-off at the detection plane.
   - Optional: Separate plots for walk-off contribution from each crystal.
 - Plot a simple 3D overview of the photon beams and crystal optical axes involved in the calculation.
 - Calculate and plot the actual polarization of photons generated by SPDC in the crystal (*Migdall effect*)[^JOS1997].
 - Take into account tip/tilt of the crystals with respect to the beam propagation axis.
 - Calculate refractive indices and group indices for various birefringent materials, based on Sellmaier equations.
   - Supported materials (the number of differing parameter sets found and implemented from different sources are given in parentheses): alpha-BBO (2), beta-BBO (2), Quartz (1), YVO (2).
 - Experimental support for Type-II SPDC, assuming an additional half-waveplate between SPDC and compensation crystal.
   
What the script **DOESN'T DO**:
 - Calculation of SPDC output angle and efficiency (-> phasematching). These properties can be calculated using [SPDCalc.org](https://SPDCalc.org).
 - Keeping track of the photon polarization when passing through crystals. If the polarization is not aligned with the optical axis of the birefringent crystal, the crystal acts like multi-order waveplates and can disturb the polarization state. This effect is very sensitive to the exact (on the order of fractions of the wavelength) crystal thickness and orientation. While this effect is not unimportant, it is pratically impossible to measure and control crystal production and setup geometry to the required level to align simulation and real life.
 - Keeping track of beam displacements and angular offsets. While beam displacement can be calculated for each crystal, it is ignored for the overall propagation of a ray through the full crystal system. For most situations, the beam displacement is much smaller than the source - detection distance and the resulting in-plane displacement due to the photon output angle. This is similarly assumed for the center - center spacing of the crossed BBO pair. To account for these offsets as well, one would need to calculate new positions on the detection plane and then match the correct phase differences at each position (e.g. by grid interpolation).
 - Asymmetric setup geometries (i.e. different signal/idler angles and wavelengths). Probably mostly requires a different way of properly summing over signal and idler phase differences, i.e. matching the correct rays of a pair.
 
 Contributions are welcome! :)
 
 
## Calculation Building Blocks 
Please also note the comments throughout the code.

### Crystal Systems
The CrystalSystem class is both a container for all the important information about the setup geometry and crystals used in it, and defines the required methods to calculate and sum over all the walk-off effects in the system. It stores this information and further provides additional methods for formatted text outputs and plots. It is the main object to deal with when setting up most calculations and retriving results. Please refer to the documentation strings in the code for details on the methods and parameters.

The CrystalSystem class treats crystals for SPDC and spatial/temporal compensation slightly differently. E.g. only the first SPDC crystals with matching optical axis and pump beam polarization create photon pairs, while all other crystals just add or compensate walk-off. We assume the usualy nomenclauture and configuration, that temporal compensation crystals (TCCs) are placed before the SPDC crystal(s) and do not contribute to spatial walk-off (as there is only the collimated pump beam travelling through it). All crystals after the SPDC crystals are called spatial compensation crystals (SCCs) and contribute to both temporal and spatial walk-off. SCCs are treated independently for signal and idler beams of the photon pairs and should have independent Crystals associated to them (when  using a common crystal for both arms, simply use a copy of the signal SCC for the idler SCC).

The CrystalSystem class also provides a method to rotate the SPDC crystal by 90Â° around the pump beam direction, which automatically rotates the compensation crystals accordingly (for crossed Type-I SPDC systems). Note, that without changes of the crystal parameters this ususally leads to a change of total temporal walk-off.

### Detection Aperture / Plane
One of the purposes of this script is to calculate spatial walk-off, i.e. the phase difference of horizontal and vertical polarization depending on the photon-pair output angle or spatial position. For the calculations done here, effectively only angles are relevant. However, it is not really intuitive to think about the problem in terms of angular ranges. Instead, it is much easier to grasp when thinking about positions on a "detection" plane instead. 

Here, we (somewhat arbitrarily) place this plane at the iris apertures in front of the lenses focussing the photon pairs onto the very small sensitive area of the actual detectors. This makes it easy to understand how spatial walk-off effects are influenced by different aperture sizes, as it just 1:1 changes the detection area integrated over in the output plots.

The detection plane and aperture size for the calculation is derived from the dictionary with keys `['hoa', 'r_aperture', 'distance', 'points']` based on the SPDC cone half-opening angle, the aperture radius, source - detection plane distance and the number of points along both plane dimensions to calculate.

> [!NOTE]
> To avoid passing the detector dictionary down to the plotting functions at every occasion (there are many), the plotting function instead uses two constants, `points` and `a_d`, and center point indices derived thereof, to define the plot grid dimensions. Their definition should match those of the detector dictionary. To be changed by a code rework in the unknown future.


### "Ray-Tracing"
From the geometric parameters for the detection plane position and aperture size, a grid of "ray" unit vectors is calculated from the straight connection between the center point of the crossed BBO crystal to the `points * points` sized grid on the detection plane. As mentioned above, we neglect any additional offsets (beams originating in two different crystals and beam displacement in crystals).

Unlike in "real" ray-tracing, we do not further track the actual positions where rays interact with crystal or detection planes (reflection and loss is ignored as well), instead we just keep track of the orientation of the unit vectors inside and outside of the crystals (Snell's law and Poyinting vector walk-off).

Additionally, the polarization for each ray is being calculated as well (perpendicular to the propagation direction), as it may be differing from the usually mentioned strict horizontal and vertical orientations. Note that, as stated above, a ray is not split into components aligned to the projections of the crystals optical axes, which may change the real polarization state after traversing a crystal (waveplate effect). Care has to be taken whether this simplification is justified for the crystal system at hand. Often, this should be the most "problematic" approximation in this calculation.

The polarization of the photons inside the crystals is rotated accordingly to be perpendicular to the propagation direction. Per default, the polarization of photon pairs generated inside the SPDC crystals is calculated to be perpendicular to the optical axis and the propagation direction and thus varies over the detection aperture (Migdall effect [^JOS1997]). This can be switched of by using one of the legacy modes (see below).

### Crystals
The Crystal class stores the relevant parameters of each crystal, which are: Material, cut and tilt angles (and derived from that the orientation of the surface normal vector and optical axis). It further contains methods for refractive and group indices calculation, as well as the actual calculation of the walk-off inside this crystal for a given array of rays.

The Crystal class does not differentiate between SPDC and temporal/spatial compensation crystals. These differences are only handled in the CrystalSystem class.

Furthermore, the Crystal class provides methods for creating copies of the configured crystal, optionally with changes to the configuration (rotation, tilting/flipping).

### Legacy modes
A bunch of options exist to make the calculation behave differently. In most cases, these modes further simplify the calculation by using additional approximations. This is mainly used for comparison with older versions of the code and with existing literature.

The legacy modes can be individually activated by appending the associated flags to the `legacy_mode` list. All available modes are listed and explained after the module import section at the beginning of the code and can be easily activated by uncommenting the respective code line.


# How To Use

The script contains some example crystals (from the Thorlabs catalog or the EDU-QOPA1) and crystal systems, defined after the module definitions. You can either import the file as a module and use these definitions in your own code or interactively in a python command line interpreter. Or you adjust the file (especially the `'__main__'` block at the end) to request the desired calculations and outputs and run it as a python script.

Running the script "as is" will reproduce figures from the EDU-QOPA1 manual:
 - Dispersion curves of refractive indices and group indices for the crossed BBO pair.
 - Spatial walk-off phase maps for the EDU-QOPA1 crystal set and setup geometry.
 - Additionally, a 3D overview plot of the beams and optical axes of all involved crystals.
 
# References To Literature
[^OptExp2005]: J. B. Altepeter, E. R. Jeffrey, and P. G. Kwiat, "Phase-compensated ultra-bright source of entangled photons", Opt. Exp. 13, 8951-8959, (2005), https://doi.org/10.1364/OPEX.13.008951

[^JOS1997]: a) A. Migdall, "Polarization directions of noncollinear phase-matched optical parametric downcoversion output", J. Opt. Soc. Am. B, 14, 1093-1098, (1997), https://doi.org/10.1364/JOSAB.14.001093;
  Similarly discussed in: b) R. Rangarajana, A. B. UâRen, and P. G. Kwiat, "Polarization dependence on downconversion emission angle: investigation of the âMigdall effectâ", Journal of Modern Optics, 58, 312â317, (2011), https://doi.org/10.1080/09500340.2010.515753

[^OptExp2009]: R. Rangarajan, M. Goggin, and P. G. Kwiat, "Optimizing type-I polarization-entangled photons", Opt. Exp. 17, 18920-18933, (2009), https://doi.org/10.1364/OE.17.018920
